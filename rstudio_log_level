#!/bin/bash

# Optional variables
LOGGING_FILE_DIR="$HOME/.rstudio/logging.conf"
DEFAULT_LOG_LEVEL="warn"

# --------------------------------------------------------- #
# Function to display help information
display_help() {
    echo
    echo "Usage: $0 [OPTION]"
    echo
    echo "Set the log-level in RStudio's logging configuration file."
    echo
    echo "Options:"
    echo "  -h, --help    Display this help message and exit."
    echo
    echo "Without any options, the script will prompt the user to select a log-level"
    echo "from the following options: debug, info, warn, error."
    echo "If the user does not provide an input, the log-level will default to '$DEFAULT_LOG_LEVEL'."
    echo "The script updates the log-level in the logging configuration file located at"
    echo "$LOGGING_FILE_DIR."
    echo
    exit 0
}

# Check for `-h` or `--help` argument
if [[ "$1" == "-h" || "$1" == "--help" ]]; then
    display_help
fi
# --------------------------------------------------------- #

# Function to print messages in color
print_color_same_line() {
    echo -ne "\033[${2}m${1}\033[0m"
}

# Check if running on macOS and adjust SED_EXT
if [[ "$(uname)" == "Darwin" ]]; then
    SED_EXT="-i ''" # macOS requires an empty string argument with -i
else
    SED_EXT="-i" # Linux and others
fi

# Print log-level information
print_color_same_line "\n" 97
print_color_same_line ">> " 97
print_color_same_line "log-level" 32
print_color_same_line " determines the verbosity of the logs generated by RStudio." 37
print_color_same_line "\n" 97
echo

##############################################################
# Condition 1 - Check if the logging configuration file exists
##############################################################

if [ ! -f "$LOGGING_FILE_DIR" ]; then
    print_color_same_line "   " 97
    print_color_same_line "$LOGGING_FILE_DIR" 96
    print_color_same_line " does not exist." 95
    print_color_same_line " No action taken." 96
    print_color_same_line "\n" 97
    echo
    exit 1
fi

##############################################################
# Condition 2 - Check if the log-level entry exists
##############################################################

# If log-level entry is not found, add it with the default value
if ! grep -q "^log-level[ =]*.*" "$LOGGING_FILE_DIR"; then
    print_color_same_line "   " 97
    print_color_same_line "log-level entry not found. Adding 'log-level=" 36
    print_color_same_line $DEFAULT_LOG_LEVEL 33
    print_color_same_line "' as default." 36
    print_color_same_line "\n" 97
    echo
    echo "log-level=$DEFAULT_LOG_LEVEL" >> "$LOGGING_FILE_DIR"
    print_color_same_line "   " 97
    print_color_same_line "log-level set to " 96
    print_color_same_line "$DEFAULT_LOG_LEVEL" 33
    print_color_same_line " in $LOGGING_FILE_DIR" 96
    print_color_same_line "\n" 97
    echo
    exit 1
fi

##############################################################
# Condition 3 - Extract the current log-level and prompt user
##############################################################

# Extract the current log level
current_log_level=$(awk -F"[[:space:]]*=[[:space:]]*" '/log-level[[:space:]]*=[[:space:]]*/ {print $2; exit}' "$LOGGING_FILE_DIR")

# Print the current level
print_color_same_line "   " 97
print_color_same_line "Current log-level is: " 36
if [[ -z "$current_log_level" ]]; then
    print_color_same_line "empty" 90
else
    print_color_same_line "$current_log_level" 33
fi
echo

# Print to select the new level
print_color_same_line "   " 97
print_color_same_line "Select new log-level (if empty, it will default to " 36
print_color_same_line $DEFAULT_LOG_LEVEL 33
print_color_same_line "): " 36
echo

# Define options
options=("debug" "info" "warn" "error")
colored_options=()

for option in "${options[@]}"; do
    colored_options+=("\033[33m${option}\033[0m")
done

# Display options
for i in "${!options[@]}"; do
    print_color_same_line "   " 97
    echo -e "$((i+1))) ${colored_options[$i]}"
done

# Prompt user for selection
while true; do
    print_color_same_line "   " 97
    print_color_same_line "Please select an option (1-${#options[@]}): " 36
    read -r selection

    # Default to DEFAULT_LOG_LEVEL if no input is provided
    if [[ -z "$selection" ]]; then
        new_log_level=$DEFAULT_LOG_LEVEL
        break
    elif [[ "$selection" =~ ^[0-9]+$ ]] && (( selection >= 1 && selection <= ${#options[@]} )); then
        new_log_level="${options[$((selection-1))]}"
        break
    else
        print_color_same_line "   " 97
        print_color_same_line "Invalid option. Please try again." 91
        echo
    fi
done

# Replace the log-level in the file
new_log_level=${new_log_level:-$DEFAULT_LOG_LEVEL}
SED_COMMAND="s/^log-level[ =]*.*/log-level=$new_log_level/"
eval "sed $SED_EXT '$SED_COMMAND' \"$LOGGING_FILE_DIR\""
print_color_same_line "\n" 97
print_color_same_line "   " 97
print_color_same_line "log-level set to " 96
print_color_same_line "$new_log_level" 33
print_color_same_line " in $LOGGING_FILE_DIR" 96
print_color_same_line "\n" 97
echo

exit 0
